name: UI Video + Copilot Agent

on:
  pull_request:
    types: [labeled]

jobs:
  record-ui-agent:
    if: contains(github.event.label.name, '~copilot-video-please')
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
      APP_URL: http://localhost:3000
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm ci

      - name: Build app
        run: |
          npm run build

      - name: Serve application in background
        run: |
          npx serve -s build -l 3000 &> serve.log &
        # Port 3000 is used; adapt if your app uses another port

      - name: Install Playwright & MCP Server
        run: |
          npm install --no-save playwright @playwright/test
          npm install --no-save @playwright/mcp@latest
          npx playwright install --with-deps

      - name: Start Playwright MCP Server
        run: |
          npx @playwright/mcp@latest --port=9222 --headless --browser=chromium &
          echo $! > mcp.pid
        # ensure the server listens on port 9222

      - name: Install Copilot CLI
        run: |
          npm install -g @githubnext/copilot-cli@latest
          copilot --version

      - name: Run Copilot agent to exercise UI and record video
        run: |
          # Example prompt: adapt to your appâ€™s UI flows
          copilot run \
            --agent "Use Playwright MCP to open the podcast-app at ${APP_URL}, navigate to the episode list, play an episode, pause it, navigate back, switch theme, verify UI is correct, record video." \
            --mcp http://localhost:9222 \
            --output ./output/agent-video.webm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: copilot-ui-video
          path: ./output/agent-video.webm

      - name: Comment PR with artifact link
        uses: actions/github-script@v7
        with:
          script: |
            const runId = process.env.GITHUB_RUN_ID;
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            const art = artifacts.find(a => a.name === 'copilot-ui-video');
            if (art) {
              const url = `https://github.com/${context.repo.owner}/${context.repo.repo}/suites/${runId}/artifacts/${art.id}`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ðŸŽ¬ Automated UI video generated by Copilot Agent: ${url}`
              });
            }
